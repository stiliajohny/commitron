name: Update Homebrew Formula

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Homebrew formula
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          FORMULA_FILE="Formula/commitron.rb"
          TEMP_DIR="/tmp/commitron-update"

          echo "üîÑ Updating Homebrew formula for version: $VERSION"

          # Create temporary directory
          mkdir -p "$TEMP_DIR"
          cd "$TEMP_DIR"

          # Download the release tarball
          echo "üì• Downloading release tarball..."
          curl -L "https://github.com/stiliajohny/commitron/archive/refs/tags/$VERSION.tar.gz" -o "commitron-$VERSION.tar.gz"

          # Calculate SHA256 checksum
          echo "üîç Calculating SHA256 checksum..."
          SHA256_CHECKSUM=$(shasum -a 256 "commitron-$VERSION.tar.gz" | cut -d' ' -f1)

          echo "‚úÖ SHA256 checksum: $SHA256_CHECKSUM"

          # Go back to project root
          cd - > /dev/null

          # Update the formula file
          echo "üìù Updating formula file..."
          sed -i \
              -e "s|url \".*\"|url \"https://github.com/stiliajohny/commitron/archive/refs/tags/$VERSION.tar.gz\"|" \
              -e "s|sha256 \".*\"|sha256 \"$SHA256_CHECKSUM\"|" \
              -e "s|# SHA256 checksum for .*|# SHA256 checksum for $VERSION release|" \
              "$FORMULA_FILE"

          # Clean up temporary files
          rm -rf "$TEMP_DIR"

          echo "‚úÖ Homebrew formula updated successfully!"

          # Verify the formula is correct
          echo "üîç Verifying formula..."
          echo "URL: $(grep 'url ' $FORMULA_FILE)"
          echo "SHA256: $(grep 'sha256 ' $FORMULA_FILE)"

      - name: Commit and push changes
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git add Formula/commitron.rb
          git commit -m "feat: update Homebrew formula for ${{ github.event.release.tag_name }}"
          git push origin HEAD
